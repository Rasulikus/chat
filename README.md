##  Сервер чата с комнатами

Это HTTP+WebSocket сервис для комнатных чатов.
Сервер поддерживает независимые комнаты с собственными участниками и реализует простой протокол обмена событиями между клиентами.
REST-API отвечает за создание комнат, их получение и управление ими, а WebSocket обеспечивает вход пользователей в комнату, обмен сообщениями в реальном времени и загрузку истории переписки.
Проект построен по слоям model => repository => service => handler, что делает код структурированным и удобным для расширения.
В качестве хранилища используется PostgreSQL, где сохраняются комнаты и история сообщений.

### Стек
- Go 1.25 
- Gin для REST
- Gorilla WebSocket для realtime
- Bun + PostgreSQL
- golang-migrate для миграций SQL
- Docker + docker-compose
- Swagger UI по пути `/swagger/index.html`

### Архитектура и возможности
- Чистая разбивка слоёв: модели, репозитории (Bun), сервисы, HTTP/WS‑хендлеры.
- Комнаты: создание с опциональным паролем, список с пагинацией и сортировкой, получение по ID, soft‑delete неактивных комнат.
- WebSocket `/ws`: подключение к комнате, отправка сообщений, получение истории.
- Миграции SQL в `migrations/` 
- Покрытие репозиториев интеграционными тестами.

### Быстрый старт
1. **Подготовка**: Go ≥ 1.25, Docker + Docker Compose, установленный `migrate` (для `Makefile`).
2. **Создать `.env`** (в проекте есть пример `.env.example`).
3. **Запуск БД**: `docker compose up -d postgres`
4. **Миграции**: `make migrateup`
5. **Старт приложения**: `go run cmd/chat/main.go`.

**Альтернатива**: поднять все сервисы одной командой `docker compose up --build` (поднимет Postgres, применит миграции и соберёт/запустит приложение).

### REST и WebSocket
- `POST /rooms` - создать комнату (опциональный пароль).
- `GET /rooms` - список с лимитом, сортировкой и курсором `before_id`.
- `GET /rooms/:id` - получить комнату.
- `GET /ws` - WebSocket. Входящие события: `join` (room_id, nick, password), `message` (text), `load_history` (before_id). Исходящие события: `message`, `history`, `join`, `error`.

### Переменные окружения
| Ключ       | Описание                               | По умолчанию |
|------------|----------------------------------------|--------------|
| HTTP_HOST  | Хост HTTP‑сервера                      | `localhost`  |
| HTTP_PORT  | Порт HTTP‑сервера                      | `8081`       |
| DB_HOST    | Хост Postgres                          | `localhost`  |
| DB_PORT    | Порт Postgres                          | `5432`       |
| DB_NAME    | Имя БД                                 | `chat`       |
| DB_USER    | Пользователь БД                        | `admin`      |
| DB_PASS    | Пароль БД                              | `mypassword` |

### Миграции
- Применить: `make migrateup`
- Откатить: `make migratedown`

### Тесты
Проект включает интеграционные тесты для слоя репозиториев.
Каждый тест изолирован и выполняется на чистой тестовой базе данных.
Проверить корректность работы репозиториев можно командой: `go test ./...`
